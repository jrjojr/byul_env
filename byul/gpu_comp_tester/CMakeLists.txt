cmake_minimum_required(VERSION 3.20)

project(gpu_comp_tester LANGUAGES C CXX)

# ----------------------------------------
# ğŸ“ ì™¸ë¶€ ë””ë ‰í† ë¦¬ ì •ì˜
# ----------------------------------------
set(EXTERNAL_DIR ${CMAKE_SOURCE_DIR}/../external)
message(STATUS "${PROJECT_NAME} : EXTERNAL_DIR = ${EXTERNAL_DIR}")

# ----------------------------------------
# ğŸ› ï¸ ê³µí†µ ì„¤ì •
# ----------------------------------------
enable_testing()

# GLSL ì…°ì´ë” ëŸ°íƒ€ì„ ë””ë ‰í† ë¦¬ (defineìœ¼ë¡œ ë„˜ê¹€)
set(SHADER_DIR "${CMAKE_INSTALL_PREFIX}/glsl")
message(STATUS "SHADER_DIR : ${SHADER_DIR}")
# ----------------------------------------
# ğŸ“¦ ì†ŒìŠ¤ ëª©ë¡
# ----------------------------------------
set(${PROJECT_NAME}_SOURCES
    ${CMAKE_CURRENT_SOURCE_DIR}/main.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/gpu.cpp
    ${CMAKE_CURRENT_SOURCE_DIR}/gpu_compute.cpp
    ${EXTERNAL_DIR}/glad/src/gl.c

CACHE INTERNAL "${PROJECT_NAME} source files"  FORCE
)

# ----------------------------------------
# ğŸ”§ ë°”ì´ë„ˆë¦¬ ìƒì„±
# ----------------------------------------
add_executable(${PROJECT_NAME} ${${PROJECT_NAME}_SOURCES})

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í”Œë«í¼ë³„ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(CMAKE_SYSTEM_NAME STREQUAL "Linux")
    message(STATUS "${PROJECT_NAME}: Applying ASan + LSan for Linux")
    target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fsanitize=leak -g -O1)
    target_link_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fsanitize=leak)
    set_target_properties(${PROJECT_NAME} PROPERTIES
        BUILD_RPATH "\$ORIGIN/../lib"
        INSTALL_RPATH "\$ORIGIN/../lib"
    )
    # ubuntu: ì‹¤í–‰íŒŒì¼ : bin, so : lib ë””ë ‰í† ë¦¬ì— ìˆì–´ì•¼ í•¨
    set_target_properties(${PROJECT_NAME} PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib
        ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib/${PROJECT_NAME}
    )    
elseif(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    message(STATUS "${PROJECT_NAME}: No ASan for Windows (unsupported).")

    # Windows: exeì™€ dllì´ í•­ìƒ ê°™ì€ bin ë””ë ‰í† ë¦¬ì— ìˆì–´ì•¼ í•¨
    set_target_properties(${PROJECT_NAME} PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib/${PROJECT_NAME}
    )
else()
    message(FATAL_ERROR "âš ï¸ Unknown platform: ${CMAKE_SYSTEM_NAME}")
endif()

# ----------------------------------------
# ğŸ§­ SDL2 / SDL3 ìë™ ë¶„ê¸° (Linux vs Windows)
# ----------------------------------------
if (CMAKE_SYSTEM_NAME STREQUAL "Linux")
    # Linuxì—ì„œëŠ” SDL2 ì‚¬ìš©
    find_package(SDL2 REQUIRED)
    target_include_directories(${PROJECT_NAME} PRIVATE ${SDL2_INCLUDE_DIRS})
    target_link_libraries(${PROJECT_NAME} PRIVATE ${SDL2_LIBRARIES})
    message(STATUS "ğŸ§ Using SDL2 on Linux: ${SDL2_LIBRARIES}")

elseif (CMAKE_SYSTEM_NAME STREQUAL "Windows")
    set(USE_SDL3 ON)  # Windowsì—ì„œëŠ” SDL3 ì‚¬ìš©

    if (MSVC)
        # -----------------------------
        # MSVC ì „ìš© SDL3 ì„¤ì •
        # -----------------------------
        set(SDL3_DIR "${EXTERNAL_DIR}/SDL3-3.2.18/msvc/cmake")
        find_package(SDL3 CONFIG REQUIRED)

        target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SDL3=1)
        target_link_libraries(${PROJECT_NAME} PRIVATE SDL3::SDL3)

        # ì‹¤í–‰ ì‹œ í•„ìš”í•œ DLL ë³µì‚¬
        set(SDL3_DLL ${EXTERNAL_DIR}/SDL3-3.2.18/msvc/bin/SDL3.dll)
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${SDL3_DLL}"
                $<TARGET_FILE_DIR:${PROJECT_NAME}>
        )
        message(STATUS "ğŸªŸ SDL3.dll copied for MSVC build: ${SDL3_DLL}")

    else()
        # -----------------------------
        # MinGW ì „ìš© SDL3 ì„¤ì •
        # -----------------------------
        set(SDL3_DIR "${EXTERNAL_DIR}/SDL3-3.2.18/mingw/cmake")
        find_package(SDL3 CONFIG REQUIRED)

        target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SDL3=1)
        target_link_libraries(${PROJECT_NAME} PRIVATE SDL3::SDL3)

        # ì‹¤í–‰ ì‹œ í•„ìš”í•œ DLL ë³µì‚¬
        set(SDL3_DLL ${EXTERNAL_DIR}/SDL3-3.2.18/mingw/x86_64-w64-mingw32/bin/SDL3.dll)
        add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
            COMMAND ${CMAKE_COMMAND} -E copy_if_different
                "${SDL3_DLL}"
                $<TARGET_FILE_DIR:${PROJECT_NAME}>
        )
        message(STATUS "ğŸªŸ SDL3.dll copied for MinGW build: ${SDL3_DLL}")
    endif()

else()
    message(FATAL_ERROR "âš ï¸ Unsupported platform: ${CMAKE_SYSTEM_NAME}")
endif()

# ----------------------------------------
# ğŸ” include ë””ë ‰í† ë¦¬
# ----------------------------------------
target_include_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_SOURCE_DIR}
    ${CMAKE_SOURCE_DIR}/core
    ${CMAKE_SOURCE_DIR}/numal

    ${CMAKE_SOURCE_DIR}/navsys/dstar_lite

    ${CMAKE_SOURCE_DIR}/balix/numal
    ${CMAKE_SOURCE_DIR}/balix/trajectory

    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_BINARY_DIR}/include/byul
    ${EXTERNAL_DIR}
    ${EXTERNAL_DIR}/glad/include
    ${SDL_INCLUDE_DIRS}
)

# ----------------------------------------
# ğŸ”— ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í¬
# ----------------------------------------
target_link_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_BINARY_DIR}/balix
)

if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    target_link_libraries(${PROJECT_NAME} PRIVATE
        ${SDL_LIBRARIES}
        opengl32
        balix
    )
else()
    target_link_libraries(${PROJECT_NAME} PRIVATE
        ${SDL_LIBRARIES}
        GL
        balix
        m
    )
endif()

# ----------------------------------------
# ğŸ§¾ ì»´íŒŒì¼ define
# ----------------------------------------
target_compile_definitions(${PROJECT_NAME} PRIVATE
    BYUL_STATIC
)

# ----------------------------------------
# ğŸ“ GLSL ì…°ì´ë” íŒŒì¼
# ----------------------------------------
set(GPU_SHADER_FILES
    ${CMAKE_CURRENT_SOURCE_DIR}/clock.comp
    ${CMAKE_CURRENT_SOURCE_DIR}/shader.vert
    ${CMAKE_CURRENT_SOURCE_DIR}/shader.frag
)

# ----------------------------------------
# GLSL ì…°ì´ë” ë³µì‚¬ (CMAKE_BINARY_DIR/glsl)
# ----------------------------------------
file(MAKE_DIRECTORY ${CMAKE_BINARY_DIR}/glsl)

file(COPY ${GPU_SHADER_FILES}
    DESTINATION ${CMAKE_BINARY_DIR}/glsl
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê³µí†µ ê²°ê³¼ë¬¼ ì„¤ì¹˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(WIN32)
    install(TARGETS ${PROJECT_NAME}
        RUNTIME DESTINATION bin
        LIBRARY DESTINATION bin
        ARCHIVE DESTINATION lib/${PROJECT_NAME}
    )
else()
    install(TARGETS ${PROJECT_NAME}
        RUNTIME DESTINATION bin
        LIBRARY DESTINATION lib
        ARCHIVE DESTINATION lib/${PROJECT_NAME}
    )
endif()

install(FILES ${GPU_SHADER_FILES}
    DESTINATION glsl
)

# SDL DLL (Windowsì—ì„œë§Œ ì„¤ì¹˜)
if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    install(FILES
        ${EXTERNAL_DIR}/SDL3-3.2.18/mingw/x86_64-w64-mingw32/bin/SDL3.dll
        DESTINATION bin
    )
    install(FILES
        ${EXTERNAL_DIR}/SDL3-3.2.18/mingw/LICENSE.txt
        DESTINATION share/sdl
    )
endif()
