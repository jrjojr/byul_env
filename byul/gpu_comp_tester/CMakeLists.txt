cmake_minimum_required(VERSION 3.20)

project(gpu_comp_tester LANGUAGES C CXX)

# ----------------------------------------
# ğŸ“ ì™¸ë¶€ ë””ë ‰í† ë¦¬ ì •ì˜
# ----------------------------------------
set(EXTERNAL_DIR ${CMAKE_SOURCE_DIR}/../external)
message(STATUS "${PROJECT_NAME} : EXTERNAL_DIR = ${EXTERNAL_DIR}")



# ----------------------------------------
# ğŸ› ï¸ ê³µí†µ ì„¤ì •
# ----------------------------------------
enable_testing()

# GLSL ì…°ì´ë” ëŸ°íƒ€ì„ ë””ë ‰í† ë¦¬ (defineìœ¼ë¡œ ë„˜ê¹€)
set(SHADER_DIR "${CMAKE_INSTALL_PREFIX}/glsl")
message(STATUS "SHADER_DIR : ${SHADER_DIR}")
# ----------------------------------------
# ğŸ“¦ ì†ŒìŠ¤ ëª©ë¡
# ----------------------------------------
set(SOURCES
    main.cpp
    gpu.cpp
    gpu_compute.cpp
    ${EXTERNAL_DIR}/glad/src/gl.c
)

# ----------------------------------------
# ğŸ”§ ë°”ì´ë„ˆë¦¬ ìƒì„±
# ----------------------------------------
add_executable(${PROJECT_NAME} ${SOURCES})

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í”Œë«í¼ë³„ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(CMAKE_SYSTEM_NAME STREQUAL "Linux")
    message(STATUS "${PROJECT_NAME}: Applying ASan + LSan for Linux")
    target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fsanitize=leak -g -O1)
    target_link_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fsanitize=leak)
    set_target_properties(${PROJECT_NAME} PROPERTIES
        BUILD_RPATH "\$ORIGIN/../lib"
        INSTALL_RPATH "\$ORIGIN/../lib"
    )
    # ubuntu: ì‹¤í–‰íŒŒì¼ : bin, so : lib ë””ë ‰í† ë¦¬ì— ìˆì–´ì•¼ í•¨
    set_target_properties(${PROJECT_NAME} PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib
        ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib/${PROJECT_NAME}
    )    
elseif(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    message(STATUS "${PROJECT_NAME}: No ASan for Windows (unsupported).")

    # Windows: exeì™€ dllì´ í•­ìƒ ê°™ì€ bin ë””ë ‰í† ë¦¬ì— ìˆì–´ì•¼ í•¨
    set_target_properties(${PROJECT_NAME} PROPERTIES
        RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
        ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib/${PROJECT_NAME}
    )
else()
    message(FATAL_ERROR "âš ï¸ Unknown platform: ${CMAKE_SYSTEM_NAME}")
endif()

# ----------------------------------------
# ğŸ§­ í”Œë«í¼ í™•ì¸ ë° SDL2 / SDL3 ìë™ ë¶„ê¸°
# ----------------------------------------
if(CMAKE_SYSTEM_NAME STREQUAL "Linux")
    find_package(SDL2 REQUIRED)
    set(SDL_INCLUDE_DIRS ${SDL2_INCLUDE_DIRS})
    set(SDL_LIBRARIES ${SDL2_LIBRARIES})

elseif(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    set(SDL3_DIR "${EXTERNAL_DIR}/SDL3-3.2.18/cmake")
    find_package(SDL3 CONFIG REQUIRED)

    set(SDL_INCLUDE_DIRS ${EXTERNAL_DIR}/SDL3-3.2.18/x86_64-w64-mingw32/include)
    set(SDL_LIBRARIES ${EXTERNAL_DIR}/SDL3-3.2.18/x86_64-w64-mingw32/bin/SDL3.dll)
    message(STATUS "ğŸªŸ SDL3 ê²½ë¡œ ì‚¬ìš©: ${SDL_INCLUDE_DIRS}")
     message(STATUS "SDL_LIBRARIES : ${SDL_LIBRARIES}")

    target_compile_definitions(${PROJECT_NAME} PRIVATE USE_SDL3=1)

    set(SDL3_DLL ${EXTERNAL_DIR}/SDL3-3.2.18/x86_64-w64-mingw32/bin/SDL3.dll)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
        "${SDL3_DLL}"
        $<TARGET_FILE_DIR:${PROJECT_NAME}>
    )
    message(STATUS "ğŸªŸ SDL3.dllì„ ${CMAKE_BINARY_DIR}/bin ìœ¼ë¡œ ë³µì‚¬í•˜ë„ë¡ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.")

    else()
    message(FATAL_ERROR "âš ï¸ Unknown platform: ${CMAKE_SYSTEM_NAME}")
endif()


# ----------------------------------------
# ğŸ” include ë””ë ‰í† ë¦¬
# ----------------------------------------
target_include_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_SOURCE_DIR}
    ${CMAKE_SOURCE_DIR}/common

    ${CMAKE_SOURCE_DIR}/navsys/dstar_lite

    ${CMAKE_SOURCE_DIR}/balix/numal
    ${CMAKE_SOURCE_DIR}/balix/trajectory

    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_BINARY_DIR}/include/byul
    ${EXTERNAL_DIR}
    ${EXTERNAL_DIR}/glad/include
    ${SDL_INCLUDE_DIRS}
)

# ----------------------------------------
# ğŸ”— ë¼ì´ë¸ŒëŸ¬ë¦¬ ë§í¬
# ----------------------------------------
target_link_directories(${PROJECT_NAME} PRIVATE
    ${CMAKE_BINARY_DIR}/balix
)

if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    target_link_libraries(${PROJECT_NAME} PRIVATE
        ${SDL_LIBRARIES}
        opengl32
        balix
    )
else()
    target_link_libraries(${PROJECT_NAME} PRIVATE
        ${SDL_LIBRARIES}
        GL
        balix
        m
    )
endif()

# ----------------------------------------
# ğŸ§¾ ì»´íŒŒì¼ define
# ----------------------------------------
target_compile_definitions(${PROJECT_NAME} PRIVATE
    BYUL_STATIC
)

# ----------------------------------------
# ğŸ“ GLSL ì…°ì´ë” íŒŒì¼
# ----------------------------------------
set(GPU_SHADER_FILES
    ${CMAKE_CURRENT_SOURCE_DIR}/clock.comp
    ${CMAKE_CURRENT_SOURCE_DIR}/shader.vert
    ${CMAKE_CURRENT_SOURCE_DIR}/shader.frag
)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê³µí†µ ê²°ê³¼ë¬¼ ì„¤ì¹˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(WIN32)
    install(TARGETS ${PROJECT_NAME}
        RUNTIME DESTINATION bin
        LIBRARY DESTINATION bin
        ARCHIVE DESTINATION lib/${PROJECT_NAME}
    )
else()
    install(TARGETS ${PROJECT_NAME}
        RUNTIME DESTINATION bin
        LIBRARY DESTINATION lib
        ARCHIVE DESTINATION lib/${PROJECT_NAME}
    )
endif()

install(FILES ${GPU_SHADER_FILES}
    DESTINATION glsl
)

# SDL DLL (Windowsì—ì„œë§Œ ì„¤ì¹˜)
if(CMAKE_SYSTEM_NAME STREQUAL "Windows")
    install(FILES
        ${EXTERNAL_DIR}/SDL3-3.2.18/x86_64-w64-mingw32/bin/SDL3.dll
        DESTINATION bin
    )
    install(FILES
        ${EXTERNAL_DIR}/SDL3-3.2.18/LICENSE.txt
        DESTINATION share/sdl
    )
endif()
