cmake_minimum_required(VERSION 3.20)

project(byul VERSION 1.0 LANGUAGES CXX)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë¹Œë“œ íƒ€ì… ë° ê¸°ë³¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# Compile DB (VSCode IntelliSense)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# DLL ë¹Œë“œì‹œ Position Independent Code í•„ìˆ˜
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# Debug ëª¨ë“œ ì •ì˜
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    add_definitions(-DDEBUG)
    message(STATUS "DEBUG mode enabled")
endif()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í…ŒìŠ¤íŠ¸ ì§€ì›
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
enable_testing()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê³µìš© ì¶œë ¥ ê²½ë¡œ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set(BYUL_INCLUDE_DIR ${CMAKE_BINARY_DIR}/include/${PROJECT_NAME})
set(BYUL_INTERNAL_DIR ${BYUL_INCLUDE_DIR}/internal)
set(BYUL_LIB_DIR ${CMAKE_BINARY_DIR}/lib)

file(MAKE_DIRECTORY ${BYUL_INCLUDE_DIR})
file(MAKE_DIRECTORY ${BYUL_INTERNAL_DIR})
file(MAKE_DIRECTORY ${BYUL_LIB_DIR})

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëª¨ë“ˆ ì¶”ê°€ (STATIC ë¼ì´ë¸ŒëŸ¬ë¦¬)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
add_subdirectory(common)
add_subdirectory(console)
add_subdirectory(navsys)
add_subdirectory(balix)
add_subdirectory(entity)
add_subdirectory(projectile)
add_subdirectory(gpu_comp_tester)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìµœì¢… DLL ìƒì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
add_library(${PROJECT_NAME} SHARED ${PROJECT_NAME}.cpp)
target_compile_definitions(${PROJECT_NAME} PRIVATE BYUL_EXPORTS)

# testsëŠ” ${PROJECT_NAME} ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•˜ë‹¤
add_subdirectory(tests)

set(SUB_MODULES
    common
    console
    navsys
    balix
    entity
    projectile
)

if (CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    target_link_libraries(${PROJECT_NAME} PRIVATE
        -Wl,--whole-archive
        ${SUB_MODULES}
        -Wl,--no-whole-archive
    )
elseif (MSVC)
    foreach(module ${SUB_MODULES})
        set(MSVC_WHOLEARCHIVE_FLAGS "${MSVC_WHOLEARCHIVE_FLAGS} /WHOLEARCHIVE:${module}")
    endforeach()
    set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS "${MSVC_WHOLEARCHIVE_FLAGS}")
    target_link_libraries(${PROJECT_NAME} PRIVATE ${SUB_MODULES})
else()
    target_link_libraries(${PROJECT_NAME} PRIVATE ${SUB_MODULES})
endif()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í—¤ë” ì„¤ì¹˜ ë° ë³µì‚¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set(HEADER_MODULES
    common
    console
    navsys
    balix
    entity
    projectile
    gpu_comp_tester    
)

foreach(module ${HEADER_MODULES})
    file(GLOB_RECURSE HEADERS
        "${CMAKE_CURRENT_SOURCE_DIR}/${module}/*.h"
        "${CMAKE_CURRENT_SOURCE_DIR}/${module}/*.hpp"
    )
    foreach(hdr ${HEADERS})
        configure_file(${hdr} ${BYUL_INTERNAL_DIR} COPYONLY)
    endforeach()    
endforeach()

file(COPY ${CMAKE_CURRENT_SOURCE_DIR}/${PROJECT_NAME}.h 
    DESTINATION ${BYUL_INCLUDE_DIR})
file(COPY byul_common.h DESTINATION ${BYUL_INCLUDE_DIR})

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í”Œë«í¼ë³„ ì„¤ì • ë° DLL ì²˜ë¦¬
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
message(STATUS "CMAKE_SYSTEM_NAME = ${CMAKE_SYSTEM_NAME}")
message(STATUS "WIN32 = ${WIN32}")
message(STATUS "UNIX = ${UNIX}")
message(STATUS "CMAKE_CXX_COMPILER_ID = ${CMAKE_CXX_COMPILER_ID}")
message(STATUS "HOST_SYSTEM_NAME = ${CMAKE_HOST_SYSTEM_NAME}")
message(STATUS "TARGET_SYSTEM_NAME = ${CMAKE_SYSTEM_NAME}")

if (CMAKE_HOST_SYSTEM_NAME STREQUAL "Linux" AND CMAKE_SYSTEM_NAME STREQUAL "Windows")
    # Ubuntuì—ì„œ MinGWë¡œ Win11 êµì°¨ ì»´íŒŒì¼
    set(HOME_DIR "$ENV{HOME}/cross_win")
    message(STATUS "ğŸ”§ Cross compile for Win11 on Ubuntu (HOME_DIR=${HOME_DIR})")

    set(MINGW_DLL_PATH "/usr/lib/gcc/x86_64-w64-mingw32/13-win32")
    set(MINGW_PTHREAD_DLL "/usr/x86_64-w64-mingw32/lib/libwinpthread-1.dll")

elseif (WIN32)
    # Win11 ë„¤ì´í‹°ë¸Œ ë¹Œë“œ
    set(HOME_DIR "$ENV{USERPROFILE}")
    message(STATUS "ğŸ  Windows build (HOME_DIR=${HOME_DIR})")

    message(STATUS "${PROJECT_NAME} No ASan for Windows (unsupported).")

    if (NOT MSVC)
        # MSYS2 MinGW ê²½ë¡œë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ë©´ ì—¬ê¸°ì„œ ìˆ˜ì • ê°€ëŠ¥
        set(MINGW_DLL_PATH "C:/msys64/mingw64/bin")
        set(MINGW_PTHREAD_DLL "C:/msys64/mingw64/bin/libwinpthread-1.dll")
    endif()

elseif (CMAKE_SYSTEM_NAME STREQUAL "Linux")
    # Ubuntu ë„¤ì´í‹°ë¸Œ ë¹Œë“œ
    set(HOME_DIR "$ENV{HOME}")
    message(STATUS "ğŸ§ Ubuntu build (HOME_DIR=${HOME_DIR})")

    # ASan/LSan ì ìš©
    message(STATUS "${PROJECT_NAME} Applying ASan + LSan for Linux")
    target_compile_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fsanitize=leak -g -O1)
    target_link_options(${PROJECT_NAME} PRIVATE -fsanitize=address -fsanitize=leak)

    # # RPATH ì„¤ì •: ../lib ê²½ë¡œì—ì„œ .so ì°¾ê¸°
    #  í˜„ì¬ í”„ë¡œì íŠ¸ê°€ dllì´ë©´ ì„¤ì •í•˜ì§€ë§Œ ì‹¤í–‰íŒŒì¼ì—ì„œ ì°¾ì•„ì•¼ì§€
    # set_target_properties(${PROJECT_NAME} PROPERTIES
    #     BUILD_RPATH "\$ORIGIN/../"
    #     INSTALL_RPATH "\$ORIGIN/../lib"        
    # )

else()
    message(FATAL_ERROR "âš ï¸ Unknown platform: ${CMAKE_SYSTEM_NAME}")
endif()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# MinGW DLL ë³µì‚¬/ì„¤ì¹˜ (Windows ë˜ëŠ” Cross-compile ê³µí†µ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if (DEFINED MINGW_DLL_PATH)
    add_custom_command(TARGET ${PROJECT_NAME} POST_BUILD
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${MINGW_DLL_PATH}/libstdc++-6.dll"
            "${CMAKE_BINARY_DIR}/libstdc++-6.dll"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${MINGW_DLL_PATH}/libgcc_s_seh-1.dll"
            "${CMAKE_BINARY_DIR}/libgcc_s_seh-1.dll"
        COMMAND ${CMAKE_COMMAND} -E copy_if_different
            "${MINGW_PTHREAD_DLL}"
            "${CMAKE_BINARY_DIR}/libwinpthread-1.dll"
    )

    set(MANDATORY_DLL
        ${CMAKE_BINARY_DIR}/libstdc++-6.dll
        ${CMAKE_BINARY_DIR}/libgcc_s_seh-1.dll
        ${CMAKE_BINARY_DIR}/libwinpthread-1.dll
    )
    install(FILES ${MANDATORY_DLL} DESTINATION bin)
endif()

set(CMAKE_INSTALL_PREFIX "${HOME_DIR}/${PROJECT_NAME}" 
    CACHE PATH "Install path" FORCE)

    message("CMAKE_INSTALL_PREFIX : ${CMAKE_INSTALL_PREFIX}")
install(TARGETS ${PROJECT_NAME}
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
    RUNTIME DESTINATION bin)

install(DIRECTORY ${BYUL_INCLUDE_DIR}/
    DESTINATION include)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# uninstall íƒ€ê²Ÿ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
configure_file(
    ${CMAKE_CURRENT_SOURCE_DIR}/cmake_uninstall.cmake.in
    ${CMAKE_BINARY_DIR}/cmake_uninstall.cmake IMMEDIATE @ONLY)

add_custom_target(uninstall
    COMMAND ${CMAKE_COMMAND} -P ${CMAKE_BINARY_DIR}/cmake_uninstall.cmake)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ZIP íŒ¨í‚¤ì§•
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
set(PACKAGE_DIR "${CMAKE_BINARY_DIR}/package_tmp")

# zip_inner ë³€ìˆ˜ë¥¼ set()ìœ¼ë¡œ ì„¤ì •
set(zip_inner "${PACKAGE_DIR}/${CMAKE_INSTALL_PREFIX}/../")

add_custom_target(package_zip
    COMMAND ${CMAKE_COMMAND} -E echo "Packaging ${PROJECT_NAME}..."
    COMMAND ${CMAKE_COMMAND} -E rm -rf ${PACKAGE_DIR}
    COMMAND ${CMAKE_COMMAND} -E make_directory ${PACKAGE_DIR}

    # DESTDIRë¥¼ ì´ìš©í•´ ì„ì‹œ ì„¤ì¹˜
    COMMAND ${CMAKE_COMMAND} -E env DESTDIR=${PACKAGE_DIR}
        ${CMAKE_COMMAND} -P ${CMAKE_BINARY_DIR}/cmake_install.cmake

    # ì••ì¶• (byul ë””ë ‰í† ë¦¬ë¥¼ í¬í•¨)
    COMMAND ${CMAKE_COMMAND} -E chdir ${zip_inner}
            ${CMAKE_COMMAND} -E tar "cfv"
            "${CMAKE_BINARY_DIR}/${PROJECT_NAME}.zip"
            --format=zip
            .

    COMMAND ${CMAKE_COMMAND} -E rm -rf ${PACKAGE_DIR}
    COMMENT "Installed to ${PACKAGE_DIR} and packaged into ${PROJECT_NAME}.zip"
)
